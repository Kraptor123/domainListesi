name: Domain Kontrol ve GÃ¼ncelleme

on:
  schedule:
    - cron: '0 * * * *'  # Her saat baÅŸÄ± Ã§alÄ±ÅŸÄ±r
  workflow_dispatch:  # Manuel tetikleme iÃ§in

env:
  FILE_PATH: eklenti_domainleri.txt
  BRANCH: main
  TZ: Europe/Istanbul  # TÃ¼rkiye saat dilimi iÃ§in bu satÄ±rÄ± ekleyin

jobs:
  domain-kontrolu:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Istanbul  # Ekstra gÃ¼venlik iÃ§in burada da tanÄ±mlayabilirsiniz

    steps:
      - name: Depoyu klonla (tam geÃ§miÅŸ)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Python kurulumu
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Gerekli paketleri yÃ¼kle
        run: |
          python -m pip install --upgrade pip
          pip install requests cloudscraper

      - name: Domainleri kontrol et ve gÃ¼ncelle
        run: |
          python - <<'EOF'
          import re
          from urllib.parse import urlparse
          from cloudscraper import CloudScraper

          scraper = CloudScraper()

          def get_final_url(url, timeout=10):
              """URL'nin son redirect edilen halini dÃ¶ndÃ¼rÃ¼r"""
              try:
                  url = url.strip().rstrip('/')
          
                  response = scraper.get(
                      url,
                      allow_redirects=True,
                      timeout=timeout,
                      headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
                  )
          
                  final_url = response.url.rstrip('/')
                  parsed = urlparse(final_url)
                  clean_url = f"{parsed.scheme}://{parsed.netloc}"
          
                  return clean_url
          
              except Exception as e:
                  print(f"Hata ({url}): {str(e)}")
                  return None

          def parse_line(line):
              """SatÄ±rÄ± parse eder: |Name:https://domain.com"""
              match = re.match(r'\|([^:]+):(https?://[^\s]+)', line.strip())
              if match:
                  name = match.group(1)
                  url = match.group(2).rstrip('/')
                  return name, url
              return None, None

          file_path = '${{ env.FILE_PATH }}'
          
          try:
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f"Dosya bulunamadÄ±: {file_path}")
              exit(1)

          original_content = content
          changes_made = False

          print("Domain kontrolleri baÅŸlÄ±yor...\n")

          lines = content.splitlines() 
          
          for i, line in enumerate(lines):
              if not line.strip() or not line.strip().startswith('|'):
                  continue
          
              name, original_url = parse_line(line)
          
              if not name or not original_url:
                  continue
          
              print(f"Kontrol ediliyor: {name}")
              print(f"  Mevcut URL: {original_url}")
          
              final_url = get_final_url(original_url)
          
              if final_url and final_url != original_url:
                  print(f"  âœ“ Yeni URL bulundu: {final_url}")
                  old_line = line
                  new_line = f"|{name}:{final_url}"
                  content = content.replace(old_line, new_line, 1)
                  changes_made = True
              else:
                  if final_url:
                      print(f"  â†’ DeÄŸiÅŸiklik yok")
                  else:
                      print(f"  âœ— EriÅŸilemedi, mevcut URL korunuyor")
          
              print()

          # DosyayÄ± sadece deÄŸiÅŸiklik varsa gÃ¼ncelle
          if changes_made and content != original_content:
              with open(file_path, 'w', encoding='utf-8') as f:
                  f.write(content)
              print("âœ“ Dosya gÃ¼ncellendi!")
          else:
              print("â†’ GÃ¼ncelleme gerekmedi.")

          EOF

      - name: DeÄŸiÅŸiklikleri kaydet ve yÃ¼kle
        env:
          BRANCH: ${{ env.BRANCH }}
          REPO: ${{ github.repository }}
          TZ: Europe/Istanbul  # TÃ¼rkiye saat dilimi
        run: |
          set -e

          # Ã–nce mevcut deÄŸiÅŸikleri stash'leyelim (varsa)
          if ! git diff --exit-code --quiet; then
            git stash push -m "temp-changes" || true
          fi

          # Remote deÄŸiÅŸiklikleri alalÄ±m
          git fetch origin $BRANCH --prune
          git pull --rebase origin $BRANCH || {
            echo "git pull --rebase sÄ±rasÄ±nda hata oluÅŸtu."
            git rebase --abort || true
            # Stash'lenmiÅŸ deÄŸiÅŸiklikleri geri alalÄ±m
            git stash pop || true
            exit 1
          }

          # Stash'lenmiÅŸ deÄŸiÅŸiklikleri geri alalÄ±m
          if git stash list | grep -q "temp-changes"; then
            git stash pop || true
          fi

          git config user.name 'Domain Kontrol Botu'
          git config user.email 'bot@github-actions'

          git add $FILE_PATH || true

          # EÄŸer staged deÄŸiÅŸiklik yoksa Ã§Ä±k
          if git diff --staged --quiet; then
            echo "DeÄŸiÅŸiklik yok, commit atlanÄ±yor"
            exit 0
          fi

          # Tarihi TÃ¼rkiye saatiyle al
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M')
          COMMIT_MSG="ğŸ”„ Domain gÃ¼ncellemesi - $CURRENT_TIME"
          git commit -m "$COMMIT_MSG" || {
            echo "Commit atÄ±lÄ±rken hata."
            git status
            exit 1
          }

          # Push yap
          git push "https://${{ secrets.PAT_TOKEN }}@github.com/${REPO}.git" HEAD:$BRANCH || {
            echo "Push baÅŸarÄ±sÄ±z oldu."
            git log --oneline -n 5
            exit 1
          }

          echo "âœ“ DeÄŸiÅŸiklikler baÅŸarÄ±yla push edildi"