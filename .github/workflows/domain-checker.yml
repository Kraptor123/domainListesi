name: Domain Kontrol ve G√ºncelleme

on:
  schedule:
    - cron: '0 * * * *'  # Her saat ba≈üƒ± √ßalƒ±≈üƒ±r
  workflow_dispatch:  # Manuel tetikleme i√ßin

jobs:
  domain-kontrolu:
    runs-on: ubuntu-latest

    steps:
      - name: Depoyu klonla
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python kurulumu
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Gerekli paketleri y√ºkle
        run: |
          pip install requests

      - name: Domainleri kontrol et ve g√ºncelle
        env:
          CLOUDFLARE_WORKER_URL: ${{ secrets.CLOUDFLARE_WORKER_URL }}
        run: |
          python - <<'EOF'
          import re
          import requests
          import os
          import time
          from urllib.parse import urlparse

          def get_final_url(url, worker_url, timeout=15):
              """Cloudflare Worker √ºzerinden URL'nin son redirect edilen halini d√∂nd√ºr√ºr"""
              try:
                  url = url.strip().rstrip('/')
          
                  # Worker'a istek yap
                  response = requests.get(
                      f"{worker_url}?url={url}",
                      timeout=timeout
                  )
          
                  if response.status_code == 200:
                      data = response.json()
          
                      # Hata kontrol√º
                      if 'error' in data:
                          print(f"    Worker hatasƒ±: {data['error']}")
                          return None
          
                      final_url = data.get('final_url', url).rstrip('/')
          
                      # URL'yi temizle (sadece domain al)
                      parsed = urlparse(final_url)
                      clean_url = f"{parsed.scheme}://{parsed.netloc}"
          
                      # Redirect varsa bildir
                      if data.get('has_redirect'):
                          print(f"    Redirect tespit edildi: {data.get('redirect_url')}")
          
                      return clean_url
                  else:
                      print(f"    Worker HTTP hatasƒ±: {response.status_code}")
                      return None
          
              except Exception as e:
                  print(f"    Hata: {str(e)}")
                  return None

          def parse_line(line):
              """Satƒ±rƒ± parse eder: |Name:https://domain.com"""
              match = re.match(r'\|([^:]+):(https?://[^\s]+)', line.strip())
              if match:
                  name = match.group(1)
                  url = match.group(2).rstrip('/')
                  return name, url
              return None, None

          # Cloudflare Worker URL'ini al
          worker_url = os.environ.get('CLOUDFLARE_WORKER_URL')
          
          if not worker_url:
              print("‚ùå HATA: CLOUDFLARE_WORKER_URL secret'ƒ± ayarlanmamƒ±≈ü!")
              print("GitHub repo -> Settings -> Secrets and variables -> Actions -> New repository secret")
              print("Name: CLOUDFLARE_WORKER_URL")
              print("Value: https://your-worker.workers.dev")
              exit(1)

          worker_url = worker_url.rstrip('/')
          print(f"Worker URL: {worker_url}\n")

          file_path = 'eklenti_domainleri.txt'
          
          try:
              with open(file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f"‚ùå Dosya bulunamadƒ±: {file_path}")
              exit(1)

          original_content = content
          changes_made = False
          total_checked = 0
          total_updated = 0

          print("=" * 60)
          print("DOMAIN KONTROL BA≈ûLIYOR (Cloudflare Worker ile)")
          print("=" * 60)
          print()

          lines = content.split('\n')
          
          for i, line in enumerate(lines):
              if not line.strip() or not line.strip().startswith('|'):
                  continue
          
              name, original_url = parse_line(line)
          
              if not name or not original_url:
                  continue
          
              total_checked += 1
              print(f"[{total_checked}] Kontrol ediliyor: {name}")
              print(f"  Mevcut URL: {original_url}")
          
              final_url = get_final_url(original_url, worker_url)
          
              # Rate limiting i√ßin kƒ±sa bekleme
              time.sleep(0.5)
          
              if final_url and final_url != original_url:
                  print(f"  ‚úÖ Yeni URL bulundu: {final_url}")
                  old_line = line
                  new_line = f"|{name}:{final_url}"
                  content = content.replace(old_line, new_line, 1)
                  changes_made = True
                  total_updated += 1
              else:
                  if final_url:
                      print(f"  ‚ÑπÔ∏è  Deƒüi≈üiklik yok")
                  else:
                      print(f"  ‚ö†Ô∏è  Eri≈üilemedi, mevcut URL korunuyor")
          
              print()

          print("=" * 60)
          print(f"√ñZET: {total_checked} domain kontrol edildi, {total_updated} g√ºncellendi")
          print("=" * 60)

          # Dosyayƒ± sadece deƒüi≈üiklik varsa g√ºncelle
          if changes_made and content != original_content:
              with open(file_path, 'w', encoding='utf-8') as f:
                  f.write(content)
              print("‚úÖ Dosya g√ºncellendi!")
          else:
              print("‚ÑπÔ∏è  G√ºncelleme gerekmedi.")

          EOF

      - name: Deƒüi≈üiklikleri kaydet ve y√ºkle
        run: |
          git config --global user.name 'Domain Kontrol Botu'
          git config --global user.email 'bot@github-actions'
          
          git add eklenti_domainleri.txt
          
          if git diff --staged --quiet; then
            echo "Deƒüi≈üiklik yok, commit atlanƒ±yor"
          else
            git pull --rebase origin main
            git commit -m "üîÑ Domain g√ºncellemesi - $(date +'%Y-%m-%d %H:%M UTC')"
            git push
            echo "‚úÖ Deƒüi≈üiklikler push edildi"
          fi